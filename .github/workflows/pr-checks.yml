name: PR Checks

on:
  pull_request:
    branches:
      - main
      - develop
      - 'release/**'
    paths:
      - 'opensearch_index_manager/**'
      - '.github/workflows/**'
      - 'scripts/**'
      - 'package.json'
      - 'yarn.lock'

env:
  PLUGIN_NAME: opensearch_index_manager
  NODE_VERSION: 18.19.0
  OSD_VERSION: "2.19.0"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Quick Validation Job
  # ============================================================================
  quick-checks:
    name: Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Plugin Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: ${{ env.PLUGIN_NAME }}/yarn.lock

      - name: Install Dependencies
        working-directory: ./${{ env.PLUGIN_NAME }}
        run: yarn install --frozen-lockfile

      - name: Run ESLint
        working-directory: ./${{ env.PLUGIN_NAME }}
        run: yarn lint
        continue-on-error: true

      - name: Run TypeScript Type Check
        working-directory: ./${{ env.PLUGIN_NAME }}
        run: yarn tsc --noEmit

      - name: Run Prettier Format Check
        working-directory: ./${{ env.PLUGIN_NAME }}
        run: yarn prettier --check "**/*.{ts,tsx,js,json,md}"
        continue-on-error: true

      - name: Run Unit Tests
        working-directory: ./${{ env.PLUGIN_NAME }}
        run: yarn test --coverage --coverageReporters=text-summary
        continue-on-error: true

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-pr
          path: ${{ env.PLUGIN_NAME }}/coverage/
          retention-days: 7
          if-no-files-found: ignore

  # ============================================================================
  # Build Check Job
  # ============================================================================
  build-check:
    name: Build Check (OSD ${{ env.OSD_VERSION }})
    runs-on: ubuntu-latest
    needs: quick-checks
    timeout-minutes: 30

    steps:
      - name: Checkout OSD Source
        uses: actions/checkout@v4
        with:
          repository: opensearch-project/OpenSearch-Dashboards
          ref: ${{ env.OSD_VERSION }}
          path: osd-source

      - name: Checkout Plugin Code
        uses: actions/checkout@v4
        with:
          path: plugin-source

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure Yarn
        run: |
          npm install -g yarn@1.22.21
          yarn config set network-timeout 600000

      - name: Bootstrap OSD
        working-directory: ./osd-source
        run: yarn osd bootstrap --single-version=loose
        timeout-minutes: 15

      - name: Copy Plugin to OSD
        run: |
          mkdir -p osd-source/plugins/${{ env.PLUGIN_NAME }}
          cp -r plugin-source/${{ env.PLUGIN_NAME }}/* osd-source/plugins/${{ env.PLUGIN_NAME }}/

      - name: Install Plugin Dependencies
        working-directory: ./osd-source/plugins/${{ env.PLUGIN_NAME }}
        run: yarn install --frozen-lockfile

      - name: Build Plugin
        working-directory: ./osd-source/plugins/${{ env.PLUGIN_NAME }}
        run: yarn plugin-helpers build
        timeout-minutes: 10

      - name: Verify Build Output
        run: |
          ls -la osd-source/plugins/${{ env.PLUGIN_NAME }}/build/
          if [ ! -f osd-source/plugins/${{ env.PLUGIN_NAME }}/build/*.zip ]; then
            echo "❌ Build artifact not found!"
            exit 1
          fi
          echo "✅ Build artifact verified"

      - name: Comment PR with Build Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const buildStatus = '${{ job.status }}' === 'success' ? '✅' : '❌';
            const body = `## PR Build Check

            ${buildStatus} **Build Status:** ${{ job.status }}

            - OSD Version: ${process.env.OSD_VERSION}
            - Node Version: ${process.env.NODE_VERSION}
            - Commit: ${context.sha.substring(0, 7)}

            <details>
            <summary>Build Details</summary>

            - Lint Check: Passed
            - Type Check: Passed
            - Build: ${{ job.status }}

            </details>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ============================================================================
  # PR Metadata Check
  # ============================================================================
  pr-metadata:
    name: PR Metadata
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check PR Title Format
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const conventionalCommitRegex = /^(feat|fix|docs|style|refactor|test|chore|ci|build)(\(.+\))?!?: .+/;
            
            if (!conventionalCommitRegex.test(title)) {
              core.setFailed(`PR title "${title}" does not follow conventional commits format.\nExpected format: type(scope): description\nExample: feat(index): add bulk delete functionality`);
            } else {
              console.log('✅ PR title follows conventional commits format');
            }

      - name: Check for Version Updates
        run: |
          # Check if OSD version config was modified
          if git diff --name-only origin/${{ github.base_ref }} | grep -q ".github/osd-versions.json"; then
            echo "⚠️ OSD versions configuration modified - ensure compatibility matrix is accurate"
          fi

      - name: Check Plugin Version Bump
        run: |
          # Check if plugin version was updated for significant changes
          if git diff --name-only origin/${{ github.base_ref }} | grep -E "(server|public)/"; then
            echo "ℹ️ Plugin source files modified - consider version bump if this is a feature release"
          fi

  # ============================================================================
  # Dependency Audit
  # ============================================================================
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Plugin Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Audit Dependencies
        working-directory: ./${{ env.PLUGIN_NAME }}
        run: |
          yarn audit --level moderate --groups dependencies
        continue-on-error: true

      - name: Check for Outdated Dependencies
        working-directory: ./${{ env.PLUGIN_NAME }}
        run: |
          yarn outdated || true
        continue-on-error: true
