name: Nightly Builds

on:
  schedule:
    # Run at 02:00 UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_tests:
        description: 'Run full test suite'
        required: false
        default: true
        type: boolean
      notify_slack:
        description: 'Send Slack notification'
        required: false
        default: false
        type: boolean

env:
  PLUGIN_NAME: opensearch_index_manager
  NODE_VERSION: 18.19.0
  OPENSEARCH_VERSION: 2.19.0

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # Determine OSD Versions to Build
  # ============================================================================
  matrix-prep:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Read OSD Versions
        id: set-matrix
        run: |
          VERSIONS=$(cat .github/osd-versions.json | jq -c '.versions')
          echo "matrix={\"osd_version\":$VERSIONS}" >> $GITHUB_OUTPUT
          echo "Building for versions: $VERSIONS"

  # ============================================================================
  # Full Build Matrix
  # ============================================================================
  nightly-build:
    name: Nightly Build OSD ${{ matrix.osd_version }}
    runs-on: ubuntu-latest
    needs: matrix-prep
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix: ${{fromJson(needs.matrix-prep.outputs.matrix)}}

    steps:
      - name: Checkout OSD Source
        uses: actions/checkout@v4
        with:
          repository: opensearch-project/OpenSearch-Dashboards
          ref: ${{ matrix.osd_version }}
          path: osd-source

      - name: Checkout Plugin Code
        uses: actions/checkout@v4
        with:
          path: plugin-source

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure Yarn
        run: |
          npm install -g yarn@1.22.21
          yarn config set network-timeout 600000

      - name: Bootstrap OSD
        working-directory: ./osd-source
        run: yarn osd bootstrap --single-version=loose
        timeout-minutes: 20

      - name: Copy Plugin to OSD
        run: |
          mkdir -p osd-source/plugins/${{ env.PLUGIN_NAME }}
          cp -r plugin-source/${{ env.PLUGIN_NAME }}/* osd-source/plugins/${{ env.PLUGIN_NAME }}/

      - name: Install Plugin Dependencies
        working-directory: ./osd-source/plugins/${{ env.PLUGIN_NAME }}
        run: yarn install --frozen-lockfile

      - name: Build Plugin
        working-directory: ./osd-source/plugins/${{ env.PLUGIN_NAME }}
        run: yarn plugin-helpers build
        timeout-minutes: 15

      - name: Get Plugin Version
        id: plugin_version
        working-directory: ./osd-source/plugins/${{ env.PLUGIN_NAME }}
        run: |
          VERSION=$(cat package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[",]//g' | tr -d '[[:space:]]')
          GIT_SHA=$(git rev-parse --short HEAD)
          NIGHTLY_VERSION="${VERSION}-nightly-$(date +%Y%m%d)-${GIT_SHA}"
          echo "version=$NIGHTLY_VERSION" >> $GITHUB_OUTPUT

      - name: Rename Build Artifact
        working-directory: ./osd-source/plugins/${{ env.PLUGIN_NAME }}/build
        run: |
          mv ${{ env.PLUGIN_NAME }}-*.zip \
             ${{ env.PLUGIN_NAME }}-${{ steps.plugin_version.outputs.version }}-osd-${{ matrix.osd_version }}.zip

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nightly-${{ env.PLUGIN_NAME }}-${{ steps.plugin_version.outputs.version }}-osd-${{ matrix.osd_version }}
          path: osd-source/plugins/${{ env.PLUGIN_NAME }}/build/${{ env.PLUGIN_NAME }}-${{ steps.plugin_version.outputs.version }}-osd-${{ matrix.osd_version }}.zip
          retention-days: 7

      - name: Record Build Status
        if: always()
        run: |
          echo "OSD_VERSION=${{ matrix.osd_version }}" >> $GITHUB_ENV
          echo "BUILD_STATUS=${{ job.status }}" >> $GITHUB_ENV

  # ============================================================================
  # Integration Tests
  # ============================================================================
  nightly-tests:
    name: Nightly Integration Tests
    runs-on: ubuntu-latest
    needs: nightly-build
    if: ${{ inputs.run_tests != false }}
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        osd_version: ["2.19.0", "2.19.4"]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman podman-compose

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          pattern: nightly-${{ env.PLUGIN_NAME }}-*-osd-${{ matrix.osd_version }}
          path: ./build

      - name: Start Test Environment
        run: |
          export OPENSEARCH_VERSION=${{ env.OPENSEARCH_VERSION }}
          export OSD_VERSION=${{ matrix.osd_version }}
          podman-compose -f podman-compose.yml up -d
          
          echo "Waiting for OpenSearch..."
          timeout 180 bash -c 'until curl -s http://localhost:9200 >/dev/null 2>&1; do sleep 5; done'
          
          echo "Waiting for OSD..."
          timeout 180 bash -c 'until curl -s http://localhost:5601/api/status | grep -q "green\|yellow"; do sleep 5; done'

      - name: Run Test Suite
        run: |
          # Install plugin
          PLUGIN_ZIP=$(find build -name "*.zip" | head -1)
          podman cp "$PLUGIN_ZIP" opensearch-dashboards:/tmp/
          podman exec opensearch-dashboards ./bin/opensearch-dashboards-plugin install file:///tmp/$(basename "$PLUGIN_ZIP")
          podman restart opensearch-dashboards
          
          # Wait for OSD
          timeout 180 bash -c 'until curl -s http://localhost:5601/api/status | grep -q "green\|yellow"; do sleep 5; done'
          
          # Run tests
          ./scripts/setup-test-data.sh || true
          
          # API tests
          curl -s http://localhost:5601/api/status | jq '.'
          curl -s http://localhost:5601/api/${{ env.PLUGIN_NAME }}/health || true

      - name: Collect Test Results
        if: always()
        run: |
          mkdir -p nightly-results/${{ matrix.osd_version }}
          podman logs opensearch > nightly-results/${{ matrix.osd_version }}/opensearch.log 2>&1 || true
          podman logs opensearch-dashboards > nightly-results/${{ matrix.osd_version }}/osd.log 2>&1 || true
          curl -s http://localhost:5601/api/status > nightly-results/${{ matrix.osd_version }}/status.json || true

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-test-results-${{ matrix.osd_version }}
          path: nightly-results/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          podman-compose -f podman-compose.yml down -v || true

  # ============================================================================
  # Security Scan
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Plugin Code
        uses: actions/checkout@v4

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './${{ env.PLUGIN_NAME }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: Run NPM Audit
        working-directory: ./${{ env.PLUGIN_NAME }}
        run: |
          yarn audit --level high --json > npm-audit.json || true
          cat npm-audit.json | jq '.advisories | length' || echo "0"
        continue-on-error: true

  # ============================================================================
  # Generate Nightly Report
  # ============================================================================
  generate-report:
    name: Generate Nightly Report
    runs-on: ubuntu-latest
    needs: [nightly-build, nightly-tests, security-scan]
    if: always()

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: nightly-*

      - name: Generate Report
        run: |
          cat > nightly-report.md << 'EOF'
          # Nightly Build Report

          **Date:** $(date -u +"%Y-%m-%d %H:%M UTC")
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}

          ## Build Status

          | OSD Version | Status | Artifact |
          |-------------|--------|----------|
          EOF

          for version in 2.19.0 2.19.1 2.19.2 2.19.3 2.19.4; do
            status="${{ needs.nightly-build.result }}"
            status_icon="${status}" == "success" ? "âœ…" : "âŒ"
            echo "| $version | $status_icon $status | Available |" >> nightly-report.md
          done

          cat >> nightly-report.md << 'EOF'

          ## Test Status

          | OSD Version | Status |
          |-------------|--------|
          | 2.19.0 | ${{ needs.nightly-tests.result }} |
          | 2.19.4 | ${{ needs.nightly-tests.result }} |

          ## Security Scan

          | Scanner | Status |
          |---------|--------|
          | Trivy | ${{ needs.security-scan.result }} |
          | NPM Audit | Completed |

          ## Artifacts

          All build artifacts are available for 7 days.
          EOF

          cat nightly-report.md

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: nightly-report
          path: nightly-report.md
          retention-days: 30

      - name: Create Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Nightly Build Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Nightly Build Failure Report

            The nightly build workflow has failed.

            ### Workflow Details
            - **Run Date:** ${new Date().toISOString()}
            - **Commit:** ${context.sha}
            - **Branch:** ${context.ref}

            ### Failed Jobs
            - Build: ${{ needs.nightly-build.result }}
            - Tests: ${{ needs.nightly-tests.result }}
            - Security Scan: ${{ needs.security-scan.result }}

            ### Action Required
            Please investigate the failures and fix the issues.

            [View Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['nightly', 'ci-failure', 'automated']
            });

      - name: Summary
        run: |
          echo "## Nightly Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build: ${{ needs.nightly-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "Tests: ${{ needs.nightly-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "Security: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
